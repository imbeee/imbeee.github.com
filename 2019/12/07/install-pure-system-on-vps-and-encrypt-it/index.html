<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="A blog containing some interesting things."><meta name="referrer" content="no-referrer"><title>给vps挂载iso安装系统并加密系统分区 | Beeeの零碎事</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">给vps挂载iso安装系统并加密系统分区</h1><a id="logo" href="/.">Beeeの零碎事</a><p class="description">Just so so~</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">给vps挂载iso安装系统并加密系统分区</h1><div class="post-meta">Dec 7, 2019</div><div class="post-content"><p>部分VPS提供商的控制面板仅提供简单的重装系统功能，只能从其提供的有限的iso中选择安装，并且无法验证iso的完整性，或者根本不提供iso挂载功能，直接使用模板重置vps。因此我们无法安装自己所需的系统和对vps系统进行全盘加密。这篇文章简单记录一下如何在vps上挂载自定义iso安装系统并进行加密。</p>
<h3 id="update-20191207"><a href="#update-20191207" class="headerlink" title="update 20191207"></a>update 20191207</h3><p>更新ubuntu 18.04相关的配置</p>
<p>netinstall镜像</p>
<p><code>http://archive.ubuntu.com/ubuntu/dists/bionic/main/installer-amd64/current/images/netboot/mini.iso</code></p>
<p>安装Busybox与dropbear</p>
<p><code>sudo apt install dropbear busybox</code></p>
<p>配置sshkey</p>
<p><code>/etc/dropbear-initramfs/authorized_keys</code></p>
<p>配置dropbear端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /etc/dropbear-initramfs/config</span><br><span class="line">DROPBEAR_OPTIONS=&quot;-p 2222&quot;</span><br></pre></td></tr></table></figure>
<p>配置initramfs网络，默认为dhcp，如需设置静态ip</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /etc/initramfs-tools/initramfs.conf</span><br><span class="line"># 添加行</span><br><span class="line">ip=client-ip::gw-ip:netmask</span><br></pre></td></tr></table></figure>
<p>更新initramfs</p>
<p><code>update-initramfs -u</code></p>
<p>启动后控制台可能会有报错</p>
<p><code>Aiee, segfault! You should probably report this as a bug to the developer</code></p>
<p>该报错参考资料：<a href="https://github.com/HRomie/dropbear-init-fix/blob/master/README.md" target="_blank" rel="noopener">https://github.com/HRomie/dropbear-init-fix/blob/master/README.md</a></p>
<p>bbr相关</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">开启</span><br><span class="line">echo &quot;net.core.default_qdisc=fq&quot; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">echo &quot;net.ipv4.tcp_congestion_control=bbr&quot; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line">验证</span><br><span class="line">sysctl net.ipv4.tcp_available_congestion_control</span><br><span class="line">lsmod | grep bbr</span><br></pre></td></tr></table></figure>
<h3 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h3><ul>
<li>为vps安装自己所需的发行版或特定的版本，如kali等</li>
<li>luks全盘加密并提供ssh远程解密，重启后直接ssh远程输入luks密钥解密，无需登录vps控制面板操作控制台会话</li>
</ul>
<h3 id="适用条件"><a href="#适用条件" class="headerlink" title="适用条件"></a>适用条件</h3><ul>
<li>使用kvm/vmware等完全虚拟化技术的vps</li>
<li>控制面板不提供iso挂载功能或仅允许挂载其提供的iso</li>
<li>控制面板需提供控制台会话访问</li>
</ul>
<h3 id="安装系统"><a href="#安装系统" class="headerlink" title="安装系统"></a>安装系统</h3><p>这里以vmware虚拟机为例子来说明如何安装全盘加密的ubuntu server 16.04。我在ESXi中准备了一台相同版本ubuntu server 16.04虚拟机，没有lvm，没有luks加密：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ uname -a</span><br><span class="line">Linux ubuntu 4.4.0-87-generic #110-Ubuntu SMP Tue Jul 18 12:55:35 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux</span><br><span class="line"></span><br><span class="line">$ cat /etc/fstab</span><br><span class="line">UUID=0041d83f-a90d-4c9e-82cf-3edf45ca6da4 /               ext4    errors=remount-ro 0       1</span><br><span class="line">UUID=d3c1de79-74a4-409b-b321-efaa3346ff6a none            swap    sw              0       0</span><br><span class="line"></span><br><span class="line">$ mount</span><br><span class="line">...</span><br><span class="line">/dev/sda1 on / type ext4 (rw,relatime,errors=remount-ro,data=ordered)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>安装过程大致是在grub2中使用memdisk将ubuntu的iso载入内存，然后引导安装。对于ubuntu来说，我们使用memdisk安装的时候用常规iso的话，在安装过程中会报”Your installation CD-ROM couldn’t be mounted. This probably means that the CD-ROM was not in the drive. If so you can insert it and try again.”这个错误，因此我们要使用网络安装版（Network installer）的iso。</p>
<p>下载syslinux，解压，并将memdisk解压到根目录备用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://www.kernel.org/pub/linux/utils/boot/syslinux/6.xx/syslinux-6.03.tar.xz</span><br><span class="line">tar xvJf syslinux-6.03.tar.xz</span><br><span class="line">cp syslinux-6.03/bios/memdisk/memdisk /</span><br></pre></td></tr></table></figure>
<p>下载ubuntu网络安装iso到根目录备用:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://archive.ubuntu.com/ubuntu/dists/xenial-updates/main/installer-amd64/current/images/netboot/mini.iso -O /mini.iso</span><br></pre></td></tr></table></figure>
<p>安装过程需要使用网络，且vps所在网络环境可能不提供DHCP服务，因此需要记录网络配置备用，包括IP地址，子网掩码，网关等。</p>
<p>然后为grub2添加新的引导菜单。这里为了方便，我们仅修改grub2相关参数，在启动时手动操作。修改配置文件<code>/etc/default/grub</code>，注释<code>GRUB_HIDDEN_TIMEOUT</code>行，修改<code>GRUB_TIMEOUT</code>数值为30，使grub2引导界面不会一闪已过，方便中断。最后运行命令<code>update-grub</code>使grub2参数生效。</p>
<p>至此，准备工作完成。重启后从vps控制面板进入控制台会话，可以发现系统停在grub2引导界面等待引导。</p>
<p><img src="https://tva1.sinaimg.cn/large/006tNc79gy1fmb1d38ll0j30zk0ssmy6.jpg" alt=""></p>
<p>按c进入命令行模式，并使用以下命令引导iso：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">insmod memdisk</span><br><span class="line">linux16 /memdisk iso</span><br><span class="line">initrd16 /mini.iso</span><br><span class="line">boot</span><br></pre></td></tr></table></figure>
<p>如果vps存在多个磁盘，可能会存在<code>memdisk</code>和<code>mini.iso</code>不在当前磁盘的情况，则需要先使用<code>search -f &quot;--set-root /mini.iso&quot;</code>来指定root。一切正常的话，我们已经可以看到ubuntu安装界面：</p>
<p><img src="https://tva1.sinaimg.cn/large/006tNc79gy1fmb1le8xgcj30zk0ss0tw.jpg" alt=""></p>
<p>安装过程和正常安装一样跟着向导一步一步操作就行。如果网络中没有DHCP服务的话会跳出手动配置网络的界面，将上面记录的网络信息填入；如果存在DHCP，但是分配的地址不能用于联网的话，在配置Hostname那一步里双击esc，选手动配置网络，然后填入网络信息。</p>
<p>配置过程中用户Home目录加密选No，因为我们采用lvm+luks全盘加密。选择磁盘界面，我们选择<code>use entire disk and setup encrypted lvm</code>：</p>
<p><img src="https://tva1.sinaimg.cn/large/006tNc79gy1fmb219eotgj318g0zgwg3.jpg" alt=""></p>
<p>选择磁盘之后输入加密密码：</p>
<p><img src="https://tva1.sinaimg.cn/large/006tNc79gy1fmb24khkivj318g0zggne.jpg" alt=""></p>
<p>最后根据向导完成安装，记得勾选安装OpenSSH Server。</p>
<p><img src="https://tva1.sinaimg.cn/large/006tNc79ly1fmb4ce7wagj318g0zgdha.jpg" alt=""></p>
<p>重启后会看到要求输入luks密码的界面：</p>
<p><img src="https://tva1.sinaimg.cn/large/006tNc79ly1fmb4dqwsjcj318g0zg75i.jpg" alt=""></p>
<p>输入刚设置的密码即可启动系统。至此，全盘加密的ubuntu server安装完成。</p>
<h3 id="远程解密系统"><a href="#远程解密系统" class="headerlink" title="远程解密系统"></a>远程解密系统</h3><p>全盘加密的系统，每次重启后都需要登录vps控制面板，在控制台会话里输入密码才能启动。我们可以将ssh集成到initramfs里，从而实现远程通过ssh输入密码解密系统。</p>
<p>在initramfs里创建root家目录与.ssh目录，并写入公钥：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/initramfs-tools/root/.ssh/</span><br><span class="line">echo &quot;your ssh public key&quot; &gt;&gt; /etc/initramfs-tools/root/.ssh/authorized_keys</span><br></pre></td></tr></table></figure>
<p>安装<code>busybox</code>与<code>dropbear</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install dropbear busybox</span><br></pre></td></tr></table></figure>
<p>编辑<code>/etc/initramfs-tools/initramfs.conf</code>，配置网络与dropbear。</p>
<p>配置网络连接<br>在<code>DEVICE=</code>下一行加入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">IP=IPADDR::GATEWAY:NETMASK::DEV:off</span><br><span class="line">// example:</span><br><span class="line">// IP=10.105.16.153::10.105.16.1:255.255.255.0::ens33:off</span><br></pre></td></tr></table></figure>
<p>更改dropbear端口，添加行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DROPBEAR_OPTIONS=&quot;-p 2222&quot;</span><br></pre></td></tr></table></figure>
<p>这里更改dropbear端口是为了避免连接时报错<code>Host key verification failed</code>，因为vps系统ssh公钥和initramfs下dropbear的公钥是不一样的。</p>
<p>加入unlock脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://gist.githubusercontent.com/gusennan/712d6e81f5cf9489bd9f/raw/fda73649d904ee0437fe3842227ad8ac8ca487d1/crypt_unlock.sh -O /etc/initramfs-tools/hooks/crypt_unlock.sh</span><br><span class="line">chmod +x /etc/initramfs-tools/hooks/crypt_unlock.sh</span><br></pre></td></tr></table></figure>
<p>最后更新initramfs</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update-initramfs -u</span><br></pre></td></tr></table></figure>
<p>重启后使用root用户通过证书认证从2222端口连接ssh，运行<code>unlock</code>命令，输入密码即可解密并引导系统。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ ssh root@ip -p 2222</span><br><span class="line">To unlock root-partition run unlock</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BusyBox v1.22.1 (Ubuntu 1:1.22.0-15ubuntu1) built-in shell (ash)</span><br><span class="line">Enter &apos;help&apos; for a list of built-in commands.</span><br><span class="line"></span><br><span class="line"># unlock</span><br><span class="line">Please unlock disk sda5_crypt:</span><br><span class="line">  /run/lvm/lvmetad.socket: connect failed: No such file or directory</span><br><span class="line">  WARNING: Failed to connect to lvmetad. Falling back to internal scanning.</span><br><span class="line">  Reading all physical volumes.  This may take a while...</span><br><span class="line">  Found volume group &quot;ubuntu-vg&quot; using metadata type lvm2</span><br><span class="line">  /run/lvm/lvmetad.socket: connect failed: No such file or directory</span><br><span class="line">  WARNING: Failed to connect to lvmetad. Falling back to internal scanning.</span><br><span class="line">  2 logical volume(s) in volume group &quot;ubuntu-vg&quot; now active</span><br><span class="line">cryptsetup: sda5_crypt set up successfully</span><br><span class="line">Connection to ip closed.</span><br></pre></td></tr></table></figure>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ul>
<li>以上操作均基于ubuntu server 16.04.3，如选择其他发行版或者其他版本，部分配置可能需要根据实际情况进行调整。</li>
<li>系统配置完成后修改用户密码和luks密码，防止在控制台会话做了键盘记录这种极端情况下密码被窃取。操作luks密码可以使用<code>cryptsetup</code>命令。</li>
<li>文中提到的全盘加密并非实际意义上的整个磁盘加密，仅指系统分区的加密，因为在启动时需要boot分区里的initramfs。</li>
<li>由于boot分区无法进行加密，第三方可以挂载此分区并对initramfs进行篡改，加入恶意代码截取密码。因此系统配置完成后，最好记录下boot分区里initramfs的hash值，在每次手动重启前确认该文件是否被篡改。或者在意外重启后，连上initramfs的ssh后手动挂载boot分区，检查文件hash，确认无误后才输入密码进行解密。</li>
</ul>
</div><div class="tags"><a href="/tags/Linux/">Linux</a></div><div class="post-nav"><a class="next" href="/2019/09/01/unload-built-in-m25p80-driver/">卸载编译到内核中的m25p80驱动</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://www.imbeee.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/Writeup/" style="font-size: 15px;">Writeup</a> <a href="/tags/Pentest/" style="font-size: 15px;">Pentest</a> <a href="/tags/Tool/" style="font-size: 15px;">Tool</a> <a href="/tags/Homelab/" style="font-size: 15px;">Homelab</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Embedded/" style="font-size: 15px;">Embedded</a> <a href="/tags/ARM/" style="font-size: 15px;">ARM</a> <a href="/tags/LKM/" style="font-size: 15px;">LKM</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="https://imbeee.github.io/" title="Github Pages备份" target="_blank">Github Pages备份</a><ul></ul><a href="https://ymr.me/" title="野蛮人の洞窟" target="_blank">野蛮人の洞窟</a><ul></ul><a href="http://bksec.net/" title="my5t3ry的blog" target="_blank">my5t3ry的blog</a><ul></ul><a href="https://www.blackh4t.org/" title="DarkRay's BLoG.!" target="_blank">DarkRay's BLoG.!</a><ul></ul><a href="https://www.iswin.org/" title="随风's Blog" target="_blank">随风's Blog</a><ul></ul><a href="http://www.00theway.org/" title="00theway's Blog" target="_blank">00theway's Blog</a><ul></ul><a href="https://threathunter.org/" title="ThreatHunter社区" target="_blank">ThreatHunter社区</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">Beeeの零碎事.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>