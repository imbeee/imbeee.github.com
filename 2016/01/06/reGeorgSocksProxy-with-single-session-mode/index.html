<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="A blog containing some interesting things."><meta name="referrer" content="no-referrer"><title>reGeorgSocksProxy修改版-可指定Cookie | Beeeの零碎事</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">reGeorgSocksProxy修改版-可指定Cookie</h1><a id="logo" href="/.">Beeeの零碎事</a><p class="description">Just so so~</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">reGeorgSocksProxy修改版-可指定Cookie</h1><div class="post-meta">Jan 6, 2016</div><div class="post-content"><p>reGeorgSocksProxy是一款渗透测试中常用到的http2socks隧道，本文简单介绍reGeorgSocksProxy的工作原理以及我在使用过程中遇到的小问题，并给出我的修改方法及最终修改后的代码。</p>
<h3 id="reGeorgSocksProxy工作原理"><a href="#reGeorgSocksProxy工作原理" class="headerlink" title="reGeorgSocksProxy工作原理"></a>reGeorgSocksProxy工作原理</h3><p>reGeorgSocksProxy由服务端和客户端两部分组成。服务端有php、aspx、asph、jsp、node.js等多个版本，客户端则由python编写。其工作原理可简单描述为python客户端在本地监听一个端口，提供socks服务，并将数据通过http/https协议发送到服务端上，并从服务端上用socket实现转发。具体流程：</p>
<ul>
<li>客户端在本地启动，用<code>bind()</code>方法绑定-l和-p参数传入的本地地址</li>
<li>客户端监听的地址有连接传入时，开启一个新线程，实例化<code>session</code>类，并在新线程里由<code>handleSocks()</code>方法对socks协议版本进行判断并调用相应的解析方法(<code>parseSocks4()</code>和<code>parseSocks5()</code>)</li>
<li>客户端从数据中解析出目标地址和目标端口，由<code>setupRemoteSession()</code>方法与服务端进行通讯，在服务端建立新的session并创建socket对象，连接到目标主机，最后将实例化后的socket对象保存到当前session，由Set-Cookie头返回sessionid</li>
<li>客户端在<code>setupRemoteSession()</code>方法返回后，保存保存sessionid到当前线程，后续由<code>writer()</code>和<code>reader()</code>方法以sessionid为标识，实现每个连接的数据交互</li>
<li>交互完成后，客户端调用<code>closeRemoteSession()</code>方法，通知服务端关闭远程链接并销毁session</li>
</ul>
<p>其中reGeorgSocksProxy的交互命令通过HTTP Headers发送，socks代理数据通过HTTP Body发送。</p>
<h3 id="两处小问题"><a href="#两处小问题" class="headerlink" title="两处小问题"></a>两处小问题</h3><p>使用过程中遇到的部分小问题，均在比较特殊的环境中才能触发。</p>
<h4 id="多个Set-Cookie头"><a href="#多个Set-Cookie头" class="headerlink" title="多个Set-Cookie头"></a>多个Set-Cookie头</h4><p>上文提到，每个链接之间的区分是靠sessionid，也就是Cookie。我们来看看reGeorgSocksProxy中处理Cookie的代码：<br><code>setupRemoteSession()</code>方法中，直接通过<code>cookie = response.getheader(&quot;set-cookie&quot;)</code>和<code>return cookie</code>来获取并且返回Cookie，而调用该方法的地方<code>self.cookie = self.setupRemoteSession(target,targetPort)</code>直接将函数返回值赋值到成员变量<code>self.cookie</code>中。我们接着看看后面引用<code>self.cookie</code>的地方。<br><code>reader()</code>中：<br><code>headers = {&quot;X-CMD&quot;: &quot;READ&quot;, &quot;Cookie&quot;: self.cookie, &quot;Connection&quot;: &quot;Keep-Alive&quot;}</code>先定义头部<br><code>response = conn.urlopen(&#39;POST&#39;, self.connectString+&quot;?cmd=read&quot;, headers=headers, body=&quot;&quot;)</code>接着发送http请求。<br>这看上去并没有什么问题，我们知道，Set-Cookie头的格式大概是这样的<br><code>Set-Cookie:PHPSESSID=638b23sd4838gvib78afgf7p36; path=/</code><br>而真正的Cookie键值对仅仅是<code>PHPSESSID=638b23sd4838gvib78afgf7p36</code>部分，后面path是Cookie的作用域。上述代码获取并存储下来的部分却是<code>PHPSESSID=638b23sd4838gvib78afgf7p36; path=/</code>，所以后续http请求发送的Cookie也是这部分。但是这也并没有什么影响，因为按照这个格式发送http请求的话，可以认为是发送了两组Cookie。<br>然而，在某些情况下，为了单点登录(SSO)或者其他原因，在web容器层面会发送一些的跨域Cookie，这样就导致客户端收到的HTTP Response包中Set-Cookie头不止一个，此时，上述代码就出问题了。<br>在存在多个Set-Cookie头的情况下，<code>response.getheader(&quot;set-cookie&quot;)</code>会返回一个List，这样在后续通讯将<code>self.cookie</code>拼接到headers中时，就会出问题，导致客户端不能正常区分会话，造成交互失败。<br>我的解决方法是做了一个小小的hack，实现了一个<code>cookieFilter()</code>方法，在<code>setupRemoteSession()</code>返回前以及<code>reader()</code>、<code>writer()</code>里对<code>self.cookie</code>赋值前，均先调用<code>cookieFilter()</code>对Cookie进行格式化输出，保证其正确性，代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">def cookiesFilter(self,cookie):</span><br><span class="line">    newcookies = [] #临时List</span><br><span class="line">    if cookie:</span><br><span class="line">        for x in cookie.split(&apos;,&apos;):</span><br><span class="line">            if &apos;;&apos; in x:</span><br><span class="line">            #如果;存在,则为带属性(如作用域名,有效时间等)的cookie,用正则匹配k-v对,并忽略跨域cookie</span><br><span class="line">                match = re.findall(&apos;((.+?)=(.+?));(\sdomain=(.+);)?&apos;,x.strip())</span><br><span class="line">                if match:</span><br><span class="line">                    if match[0][4] == self.httpHost or match[0][4] == &apos;&apos;:</span><br><span class="line">                        self.cookieDic[match[0][1]] = match[0][2]</span><br><span class="line">            else:</span><br><span class="line">                self.cookieDic[x.split(&apos;=&apos;)[0]] = x.split(&apos;=&apos;)[1]</span><br><span class="line">    #self.cookieDic为用来保存cookie的字典</span><br><span class="line">    for k in self.cookieDic.keys():</span><br><span class="line">        newcookies.append(k + &apos;=&apos; + self.cookieDic[k])</span><br><span class="line">    return &apos;; &apos;.join(newcookies)</span><br></pre></td></tr></table></figure></p>
<p>这样就保证了在多个Set-Cookie头的情况下reGeorgSocksProxy能正确处理Cookie并正常工作。</p>
<h4 id="Java-WEB、ASP-NET等存在filter的情况下的登录问题"><a href="#Java-WEB、ASP-NET等存在filter的情况下的登录问题" class="headerlink" title="Java WEB、ASP.NET等存在filter的情况下的登录问题"></a>Java WEB、ASP.NET等存在filter的情况下的登录问题</h4><p>另一个问题就是在某些java web环境下存在filter，会导致对服务端的访问被拦截，必须带上登录后的Cookie才能正常访问。而根据上文分析，reGeorgSocksProxy客户端与服务端的通讯是基于session来区分的，并不支持在指定的session下进行。<br>再来重复一下reGeorgSocksProxy的流程：</p>
<ul>
<li>客户端监听</li>
<li>传入链接</li>
<li>服务端新建session，初始化socket，保存到session</li>
<li>交互</li>
<li>关闭socket，销毁session</li>
<li>结束</li>
</ul>
<p>于是我们要解决这个问题，本质就是修改客户端和服务端，使其支持在指定的session下工作，修改后的期望流程是：</p>
<ul>
<li>客户端监听</li>
<li>传入连接</li>
<li>初始化socket，保存到指定session</li>
<li>交互</li>
<li>从指定session中关闭socket，并释放</li>
<li>结束</li>
</ul>
<p>修改的地方：</p>
<ul>
<li>增加命令行参数，用于输入指定的Cookie</li>
<li>修改程序逻辑，如果传入了自定的Cookie，则在<code>session</code>类的构造函数中将自定Cookie写入<code>self.cookieDic</code>，并生成一个随机id，用于在同一个session里却分不同的<code>socket</code></li>
<li>在调用初始化方法<code>setupRemoteSession()</code>时，如果传入了自定的Cookie，则要带上自定Cookie，表示复用已存在的session，并同时传入生成的随机socket id，在初始化socket时用于命名区分</li>
<li>同理，如果处于复用session模，<code>reader()</code>和<code>writer()</code>方法中也要向服务端传入socket id</li>
<li>服务端作相应修改，具体见代码</li>
</ul>
<p>好了，大概就是如上，懒得写了，详细改动见代码。<br><a href="http://lab.imbeee.com/res/reGeorgSocksProxy-with-single-session-mode/reGeorgSocksProxy-with-single-session-mode.rar" target="_blank" rel="noopener">下载地址</a></p>
</div><div class="tags"><a href="/tags/Pentest/">Pentest</a><a href="/tags/Tool/">Tool</a></div><div class="post-nav"><a class="pre" href="/2016/01/11/ISG2015-RPG-400-Writeup/">ISG2015-RPG-400-Writeup</a><a class="next" href="/2016/01/03/WebLogicPasswordDecryptor-GUI/">WebLogic密码解密工具</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://www.imbeee.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/Writeup/" style="font-size: 15px;">Writeup</a> <a href="/tags/Pentest/" style="font-size: 15px;">Pentest</a> <a href="/tags/Tool/" style="font-size: 15px;">Tool</a> <a href="/tags/Homelab/" style="font-size: 15px;">Homelab</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Embedded/" style="font-size: 15px;">Embedded</a> <a href="/tags/ARM/" style="font-size: 15px;">ARM</a> <a href="/tags/LKM/" style="font-size: 15px;">LKM</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="https://imbeee.github.io/" title="Github Pages备份" target="_blank">Github Pages备份</a><ul></ul><a href="https://ymr.me/" title="野蛮人の洞窟" target="_blank">野蛮人の洞窟</a><ul></ul><a href="http://bksec.net/" title="my5t3ry的blog" target="_blank">my5t3ry的blog</a><ul></ul><a href="https://www.blackh4t.org/" title="DarkRay's BLoG.!" target="_blank">DarkRay's BLoG.!</a><ul></ul><a href="https://www.iswin.org/" title="随风's Blog" target="_blank">随风's Blog</a><ul></ul><a href="http://www.00theway.org/" title="00theway's Blog" target="_blank">00theway's Blog</a><ul></ul><a href="https://threathunter.org/" title="ThreatHunter社区" target="_blank">ThreatHunter社区</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">Beeeの零碎事.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>